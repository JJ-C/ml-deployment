apiVersion: machinelearning.seldon.io/v1
kind: SeldonDeployment
metadata:
  name: fraud-detector
  namespace: ml-models
spec:
  name: fraud-detector
  predictors:
  - name: default
    replicas: 1
    graph:
      name: classifier
      type: MODEL
      implementation: SKLEARN_SERVER
      modelUri: file:///mnt/models
      parameters:
      - name: method
        type: STRING
        value: predict_proba
    componentSpecs:
    - spec:
        containers:
        - name: classifier
          image: seldonio/sklearnserver:1.17.1
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"
          env:
          - name: CASSANDRA_HOST
            value: "host.docker.internal"
          - name: CASSANDRA_PORT
            value: "9042"
          - name: MLFLOW_TRACKING_URI
            value: "http://host.docker.internal:5000"
          volumeMounts:
          - name: model-storage
            mountPath: /mnt/models
        volumes:
        - name: model-storage
          emptyDir: {}
        initContainers:
        - name: model-loader
          image: python:3.9-slim
          command:
          - sh
          - -c
          - |
            pip install mlflow boto3 scikit-learn xgboost &&
            python -c "
            import mlflow
            mlflow.set_tracking_uri('http://host.docker.internal:5000')
            model = mlflow.pyfunc.load_model('models:/fraud_detector/Production')
            import joblib
            joblib.dump(model, '/mnt/models/model.pkl')
            print('Model downloaded successfully')
            "
          volumeMounts:
          - name: model-storage
            mountPath: /mnt/models
          env:
          - name: MLFLOW_TRACKING_URI
            value: "http://host.docker.internal:5000"
    svcOrchSpec:
      env:
      - name: SELDON_LOG_LEVEL
        value: DEBUG

---
apiVersion: v1
kind: Service
metadata:
  name: fraud-detector-nodeport
  namespace: ml-models
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: fraud-detector
  ports:
  - name: http
    port: 8000
    targetPort: 8000
    nodePort: 30000
  - name: grpc
    port: 5001
    targetPort: 5001
    nodePort: 30001
